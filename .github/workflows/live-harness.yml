name: Live Harness

on:
  schedule:
    # GitHub Actions cron does not support true "every 2 weeks", so we trigger weekly
    # and gate scheduled runs to alternating ISO weeks in the job steps below.
    - cron: "30 2 * * 0"
  workflow_dispatch:
    inputs:
      harness_repos:
        description: "Comma-separated GitHub repo allowlist"
        required: false
        default: "test-glm5-demo,SimpleAdminReporter,demo-spring"
      harness_scenario:
        description: "Optional single scenario_id filter"
        required: false
        default: ""
      repo_url_override:
        description: "Optional one-off repo URL override"
        required: false
        default: ""
      continue_on_error:
        description: "Continue running remaining scenarios after failure"
        required: false
        type: choice
        options:
          - "1"
          - "0"
        default: "1"
      onboard_mode:
        description: "Onboard mode"
        required: false
        type: choice
        options:
          - windmill
          - agent
        default: windmill
      step_engine:
        description: "Step execution engine"
        required: false
        type: choice
        options:
          - dummy
          - opencode
        default: dummy

jobs:
  live-harness:
    runs-on: ubuntu-latest
    timeout-minutes: 300
    env:
      DEVGODZILLA_RUN_E2E_HARNESS: "1"
      # Allow either secret name; importer accepts both env vars.
      DEVGODZILLA_WINDMILL_TOKEN: ${{ secrets.DEVGODZILLA_WINDMILL_TOKEN }}
      WINDMILL_TOKEN: ${{ secrets.WINDMILL_TOKEN }}
      HARNESS_GITHUB_OWNER: "ilyafedotov-ops"
      HARNESS_GITHUB_REPOS: ${{ github.event_name == 'workflow_dispatch' && inputs.harness_repos || 'test-glm5-demo,SimpleAdminReporter,demo-spring' }}
      HARNESS_SCENARIO: ${{ github.event_name == 'workflow_dispatch' && inputs.harness_scenario || '' }}
      HARNESS_REPO_URL_OVERRIDE: ${{ github.event_name == 'workflow_dispatch' && inputs.repo_url_override || '' }}
      HARNESS_CONTINUE_ON_ERROR: ${{ github.event_name == 'workflow_dispatch' && inputs.continue_on_error || '1' }}
      HARNESS_ONBOARD_MODE: ${{ github.event_name == 'workflow_dispatch' && inputs.onboard_mode || 'windmill' }}
      HARNESS_STEP_ENGINE: ${{ github.event_name == 'workflow_dispatch' && inputs.step_engine || 'dummy' }}
    steps:
      - name: Biweekly schedule gate
        if: github.event_name == 'schedule'
        id: biweekly_gate
        run: |
          iso_week="$(date -u +%V)"
          if (( 10#$iso_week % 2 == 0 )); then
            echo "run_harness=true" >> "$GITHUB_OUTPUT"
            echo "Running live harness on ISO week $iso_week."
          else
            echo "run_harness=false" >> "$GITHUB_OUTPUT"
            echo "Skipping live harness on ISO week $iso_week (off week)."
          fi

      - uses: actions/checkout@v4
        if: github.event_name != 'schedule' || steps.biweekly_gate.outputs.run_harness == 'true'

      - name: Bootstrap
        if: github.event_name != 'schedule' || steps.biweekly_gate.outputs.run_harness == 'true'
        run: scripts/ci/bootstrap.sh

      - name: Run Live Harness
        if: github.event_name != 'schedule' || steps.biweekly_gate.outputs.run_harness == 'true'
        run: scripts/ci/test-harness-live.sh

      - name: Upload Harness Artifacts
        if: always() && (github.event_name != 'schedule' || steps.biweekly_gate.outputs.run_harness == 'true')
        uses: actions/upload-artifact@v4
        with:
          name: live-harness-${{ github.run_id }}
          path: |
            runs/harness/**
          if-no-files-found: warn
          retention-days: 14
