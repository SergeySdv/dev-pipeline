{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://devgodzilla.local/schemas/e2e-workflow-harness.schema.json",
  "title": "DevGodzilla E2E Workflow Harness",
  "description": "Schema definitions for live workflow harness scenarios and adapters.",
  "$ref": "#/$defs/scenario",
  "$defs": {
    "repo": {
      "type": "object",
      "additionalProperties": false,
      "required": ["owner", "name", "default_branch"],
      "properties": {
        "owner": {
          "type": "string",
          "minLength": 1
        },
        "name": {
          "type": "string",
          "minLength": 1
        },
        "url": {
          "type": "string",
          "format": "uri"
        },
        "default_branch": {
          "type": "string",
          "minLength": 1
        },
        "pin_ref": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "retry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["max_attempts", "backoff_seconds", "max_backoff_seconds"],
      "properties": {
        "max_attempts": {
          "type": "integer",
          "minimum": 1
        },
        "backoff_seconds": {
          "type": "number",
          "minimum": 0
        },
        "max_backoff_seconds": {
          "type": "number",
          "minimum": 0
        }
      }
    },
    "timeouts": {
      "type": "object",
      "additionalProperties": false,
      "required": ["onboard_seconds", "planning_seconds", "execution_seconds"],
      "properties": {
        "onboard_seconds": {
          "type": "integer",
          "minimum": 1
        },
        "planning_seconds": {
          "type": "integer",
          "minimum": 1
        },
        "execution_seconds": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "workflow": {
      "type": "object",
      "additionalProperties": false,
      "required": ["stages"],
      "properties": {
        "stages": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    },
    "expectations": {
      "type": "object",
      "additionalProperties": false,
      "required": ["discovery_outputs", "min_protocol_steps", "terminal_protocol_status"],
      "properties": {
        "discovery_outputs": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "min_protocol_steps": {
          "type": "integer",
          "minimum": 1
        },
        "terminal_protocol_status": {
          "type": "string",
          "minLength": 1
        },
        "artifact_patterns": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    },
    "scenario": {
      "type": "object",
      "additionalProperties": false,
      "required": ["scenario_id", "repo", "adapter_id", "workflow", "expectations", "timeouts", "retries"],
      "properties": {
        "scenario_id": {
          "type": "string",
          "pattern": "^[a-z0-9][a-z0-9_-]*$"
        },
        "source": {
          "type": "string",
          "default": "github_user_allowlist"
        },
        "repo": {
          "$ref": "#/$defs/repo"
        },
        "adapter_id": {
          "type": "string",
          "pattern": "^[a-z0-9][a-z0-9_-]*$"
        },
        "workflow": {
          "$ref": "#/$defs/workflow"
        },
        "expectations": {
          "$ref": "#/$defs/expectations"
        },
        "timeouts": {
          "$ref": "#/$defs/timeouts"
        },
        "retries": {
          "$ref": "#/$defs/retry"
        }
      }
    },
    "adapter": {
      "type": "object",
      "additionalProperties": false,
      "required": ["adapter_id", "required_paths", "path_aliases", "artifact_patterns", "worktree_branch_expectations"],
      "properties": {
        "adapter_id": {
          "type": "string",
          "pattern": "^[a-z0-9][a-z0-9_-]*$"
        },
        "required_paths": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "path_aliases": {
          "type": "object",
          "additionalProperties": {
            "type": "string",
            "minLength": 1
          }
        },
        "discovery_expectations": {
          "type": "object",
          "additionalProperties": true
        },
        "artifact_patterns": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          }
        },
        "worktree_branch_expectations": {
          "type": "object",
          "additionalProperties": false,
          "required": ["branch_prefix", "require_worktree_registration"],
          "properties": {
            "branch_prefix": {
              "type": "string",
              "minLength": 1
            },
            "require_worktree_registration": {
              "type": "boolean"
            }
          }
        }
      }
    }
  }
}
